{{/* Bloque PEOPLE con filtrado estricto por user_groups
     - Compatible con autores en content/authors/<slug>/_index.md
     - Lee grupos desde block.content.user_groups o block.user_groups
     - Respeta design.columns, design.compact, design.css_class
*/}}

{{ $b := .block }}
{{ $content := $b.content | default dict }}
{{ $design  := $b.design  | default dict }}

{{/* Título y texto */}}
{{ $title := or $content.title $b.title | default "Personas" }}
{{ $text  := $content.text | default "" }}

{{/* Grupos pedidos en el bloque (acepta user_groups o groups, en content o en block) */}}
{{ $groups := slice }}
{{ with $content.user_groups }}{{ $groups = . }}{{ end }}
{{ if eq (len $groups) 0 }}
  {{ with (index $content "groups") }}{{ $groups = . }}{{ end }}
{{ end }}
{{ if eq (len $groups) 0 }}
  {{ with $b.user_groups }}{{ $groups = . }}{{ end }}
{{ end }}
{{ if eq (len $groups) 0 }}
  {{ with (index $b "groups") }}{{ $groups = . }}{{ end }}
{{ end }}

{{/* Columnas */}}
{{ $cols := $design.columns | default 4 }}
{{ $grid := "grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4" }}
{{ if eq $cols 1 }}{{ $grid = "grid-cols-1" }}{{ end }}
{{ if eq $cols 2 }}{{ $grid = "grid-cols-1 sm:grid-cols-2" }}{{ end }}
{{ if eq $cols 3 }}{{ $grid = "grid-cols-1 sm:grid-cols-2 lg:grid-cols-3" }}{{ end }}
{{ if eq $cols 5 }}{{ $grid = "grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-5" }}{{ end }}
{{ if eq $cols 6 }}{{ $grid = "grid-cols-2 md:grid-cols-3 lg:grid-cols-6" }}{{ end }}
{{ if eq $cols 7 }}{{ $grid = "grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-7" }}{{ end }}

{{/* Compact spacing */}}
{{ $pad := cond ($design.compact) "py-4" "py-8" }}

{{/* Todas las páginas bajo la sección authors (incluye _index.md) */}}
{{ $all := where site.Pages "Section" "authors" }}

{{/* Filtrado por grupos (intersección no vacía). 
      Si no se pasan grupos, mostramos todos (comportamiento por defecto). */}}
{{ $people := slice }}
{{ if gt (len $groups) 0 }}
  {{ range $all }}
    {{ $ugs := .Params.user_groups | default (slice) }}
    {{ if gt (len (intersect $ugs $groups)) 0 }}
      {{ $people = $people | append . }}
    {{ end }}
  {{ end }}
{{ else }}
  {{ $people = $all }}
{{ end }}

<section id="{{ $b.id | default (anchorize $title) }}" class="{{ $pad }} {{ $design.css_class }}">
  <div class="container mx-auto px-6">
    <details class="group rounded-2xl border shadow-sm bg-white dark:bg-gray-900" {{ if $content.start_open }}open{{ end }}>
      <summary class="flex items-center justify-between cursor-pointer p-4">
        <div class="min-w-0">
          <span class="block text-2xl font-bold">{{ $title }}</span>
          {{ with $text }}<span class="block text-gray-600 dark:text-gray-300 mt-1">{{ . | markdownify }}</span>{{ end }}
        </div>
        <span aria-hidden="true" class="ml-4 select-none text-xl leading-none">▾</span>
      </summary>

      <div class="p-4">
        {{ if gt (len $people) 0 }}
          <div class="grid {{ $grid }} gap-4">
            {{ range $p := $people }}
              <a href="{{ $p.RelPermalink }}" class="group flex flex-col items-center gap-1 bg-transparent border-0 shadow-none p-0">
                <div class="w-auto h-auto">
                  {{ with $p.Resources.GetMatch "avatar*" }}
                    <img src="{{ .RelPermalink }}" alt="{{ $p.Title }}" class="w-24 h-24 rounded-full object-cover" loading="lazy">
                  {{ else }}
                    {{ with $p.Params.image }}
                      <img src="{{ . | relURL }}" alt="{{ $p.Title }}" class="w-24 h-24 rounded-full object-cover" loading="lazy">
                    {{ end }}
                  {{ end }}
                </div>
                <div class="text-center p-0">
                  <div class="font-semibold">{{ $p.Title }}</div>
                  {{ with $p.Params.role }}<div class="text-sm opacity-70">{{ . }}</div>{{ end }}
                </div>
              </a>
            {{ end }}
          </div>
        {{ else }}
          {{ if gt (len $groups) 0 }}
            <div class="text-gray-500 dark:text-gray-400">
              No se encontraron personas en los grupos: {{ delimit $groups ", " " y " }}.
            </div>
          {{ else }}
            <div class="text-gray-500 dark:text-gray-400">
              No se encontraron perfiles de autores. Verifica <code>content/authors/&lt;slug&gt;/_index.md</code>.
            </div>
          {{ end }}
        {{ end }}
      </div>
    </details>
  </div>
</section>
